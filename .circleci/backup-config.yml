version: 2.1

# this allows you to use CircleCI's dynamic configuration feature
setup: true

# --------------- Parameters (from Github Actions) ---------------
parameters:
    GHA_Actor:
        type: string
        default: ''
    GHA_Action:
        type: string
        default: ''
    GHA_Event:
        type: string
        default: ''
    GHA_Meta:
        type: string
        default: ''

# the continuation orb is required in order to use dynamic configuration
orbs:
  continuation: circleci/continuation@1.0.0

# our defined job, and its steps
jobs:
  setup:
    executor: continuation/default
    steps:
      - checkout # checkout code
        # https://discuss.circleci.com/t/dynamically-set-parameter-values-of-matrix/47172
      - run:
          name: Computed targeted package from published packages
          command: |
            # mock code to calculate TARGET_PACKAGES
            echo "export TARGET_PACKAGES='[\"@sp/app-form\",\"@sp/shell-form\"]'" >> "$BASH_ENV"
      - run:
          name: Generate Pipeline continue_config.yml file
          command: |
            .circleci/scripts/generate_config.sh
      - continuation/continue:
          configuration_path: .circleci/continue_config.yml # use freshly updated config to continue
          # Pipeline parameters provided on setup are forwared to continue pipeline ?
          # parameters: '{"GHA_Meta":"<< pipeline.parameters.GHA_Meta >>"}'

# our single workflow, that triggers the setup job defined above
workflows:
  setup:
    # Workflow run when CI was triggered from a GHAction
    when: << pipeline.parameters.GHA_Action >>
    jobs:
      - setup
